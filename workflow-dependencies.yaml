---
# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾å­˜é–¢ä¿‚å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å„ãƒ•ã‚§ãƒ¼ã‚ºé–“ã®å®Ÿè¡Œé †åºã€å‰ææ¡ä»¶ã€ä¸¦è¡Œå®Ÿè¡Œå¯èƒ½æ€§ã‚’å®šç¾©ã—ã¾ã™

version: "1.0"
description: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¾å­˜é–¢ä¿‚ã¨ãƒ«ãƒ¼ãƒ«å®šç¾©"

# ãƒ•ã‚§ãƒ¼ã‚ºå®šç¾©ã¨ä¾å­˜é–¢ä¿‚
phases:
  # Phase 1: è¦ä»¶å®šç¾©
  requirements:
    name: "è¦ä»¶å®šç¾©"
    description: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦ä»¶ã‚’æ˜ç¢ºåŒ–"
    entry_point: "project-requirements.md"
    prerequisites:
      phases: []  # æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºãªã®ã§å‰æãƒ•ã‚§ãƒ¼ã‚ºãªã—
      documents: []  # å¿…é ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã—
      conditions:
        - type: "project_initialized"
          required: true
    outputs:
      documents:
        - "requirements.md"
        - "qa/requirements-qa.md"
      state_updates:
        - "project.type"
        - "responses.requirements"
    can_parallel_with: []
    blocks: ["analysis", "design", "tasks"]  # ã“ã‚Œã‚‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’ãƒ–ãƒ­ãƒƒã‚¯
    approval_required: true
    rollback_allowed: true
    retry_on_failure: true
    max_retries: 3

  # Phase 2: æŠ€è¡“èª¿æŸ»ãƒ»åˆ†æ
  analysis:
    name: "æŠ€è¡“èª¿æŸ»ãƒ»åˆ†æ"
    description: "æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®é¸å®šã¨å®Ÿç¾å¯èƒ½æ€§ã®æ¤œè¨¼"
    entry_point: "project-analysis.md"
    prerequisites:
      phases:
        - phase: "requirements"
          status: "approved"
          error_message: "è¦ä»¶å®šç¾©ãŒæ‰¿èªã•ã‚Œã¦ã„ã¾ã›ã‚“"
      documents:
        - path: ".claude/spec/requirements.md"
          required: true
          error_message: "è¦ä»¶å®šç¾©æ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
      conditions:
        - type: "requirements_complete"
          check: "phases.requirements.approval_status == 'approved'"
    outputs:
      documents:
        - "tech-analysis.md"
        - "tech-stack.md"
        - "qa/analysis-qa.md"
      state_updates:
        - "responses.analysis"
        - "project.tech_stack"
    can_parallel_with: ["documentation_planning"]
    blocks: ["design", "tasks", "implementation"]
    approval_required: true
    rollback_allowed: true

  # Phase 3: è©³ç´°è¨­è¨ˆ
  design:
    name: "è©³ç´°è¨­è¨ˆ"
    description: "ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨è©³ç´°è¨­è¨ˆ"
    entry_point: "project-design.md"
    prerequisites:
      phases:
        - phase: "requirements"
          status: "approved"
        - phase: "analysis"
          status: "approved"
          error_message: "æŠ€è¡“èª¿æŸ»ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“"
      documents:
        - path: ".claude/spec/requirements.md"
          required: true
        - path: ".claude/spec/tech-analysis.md"
          required: true
      conditions:
        - type: "tech_stack_defined"
          check: "project.tech_stack != null"
    outputs:
      documents:
        - "design.md"
        - "architecture.md"
        - "data-models.md"
        - "api-spec.md"
        - "qa/design-qa.md"
      state_updates:
        - "responses.design"
        - "project.architecture"
    can_parallel_with: ["test_planning", "documentation"]
    blocks: ["tasks", "implementation"]
    approval_required: true
    rollback_allowed: true
    validation_required: true  # è¨­è¨ˆã®å¦¥å½“æ€§æ¤œè¨¼ãŒå¿…è¦

  # Phase 4: ã‚¿ã‚¹ã‚¯åˆ†è§£
  tasks:
    name: "å®Ÿè£…ã‚¿ã‚¹ã‚¯åˆ†è§£"
    description: "å®Ÿè£…ã‚¿ã‚¹ã‚¯ã®è©³ç´°åˆ†è§£ã¨è¦‹ç©ã‚‚ã‚Š"
    entry_point: "project-tasks.md"
    prerequisites:
      phases:
        - phase: "design"
          status: "approved"
          error_message: "è©³ç´°è¨­è¨ˆãŒæ‰¿èªã•ã‚Œã¦ã„ã¾ã›ã‚“"
      documents:
        - path: ".claude/spec/design.md"
          required: true
        - path: ".claude/spec/architecture.md"
          required: false  # ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      conditions:
        - type: "design_complete"
          check: "phases.design.approval_status == 'approved'"
    outputs:
      documents:
        - "tasks.md"
        - "task-dependencies.md"
        - "qa/tasks-qa.md"
      state_updates:
        - "responses.tasks"
        - "project.task_count"
        - "project.estimated_hours"
    can_parallel_with: ["test_case_creation"]
    blocks: []  # æœ€çµ‚ãƒ•ã‚§ãƒ¼ã‚ºãªã®ã§ãƒ–ãƒ­ãƒƒã‚¯ãªã—
    approval_required: true
    rollback_allowed: true

# ä¸¦è¡Œå®Ÿè¡Œå¯èƒ½ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ã‚§ãƒ¼ã‚º
optional_phases:
  documentation_planning:
    name: "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¨ˆç”»"
    can_start_after: ["analysis"]
    can_run_with: ["design", "tasks"]
    required: false

  test_planning:
    name: "ãƒ†ã‚¹ãƒˆè¨ˆç”»"
    can_start_after: ["design"]
    can_run_with: ["tasks"]
    required: true  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹

  test_case_creation:
    name: "ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ"
    can_start_after: ["tasks"]
    required: false

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
project_types:
  web_application:
    required_phases: ["requirements", "analysis", "design", "tasks"]
    optional_phases: ["test_planning", "documentation_planning"]
    skip_phases: []
    phase_customization:
      design:
        additional_outputs: ["ui-mockups.md", "user-flow.md"]
      tasks:
        additional_outputs: ["deployment-tasks.md"]

  mobile_app:
    required_phases: ["requirements", "analysis", "design", "tasks"]
    optional_phases: ["ui_design", "user_testing_plan"]
    skip_phases: ["server_deployment"]
    phase_customization:
      design:
        additional_outputs: ["screens.md", "navigation-flow.md"]

  scraping_system:
    required_phases: ["requirements", "analysis", "tasks"]
    optional_phases: ["design"]  # ã‚·ãƒ³ãƒ—ãƒ«ãªå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½
    skip_phases: ["ui_design"]
    phase_customization:
      analysis:
        additional_outputs: ["target-site-analysis.md", "data-structure.md"]
      tasks:
        focus: "parser_implementation"

  api_service:
    required_phases: ["requirements", "analysis", "design", "tasks"]
    optional_phases: ["load_testing_plan"]
    skip_phases: ["ui_design"]
    phase_customization:
      design:
        additional_outputs: ["endpoint-spec.md", "auth-flow.md"]

# æ¡ä»¶åˆ†å²ãƒ«ãƒ¼ãƒ«
conditional_rules:
  # ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ¢ãƒ¼ãƒ‰
  - condition: "project.type == 'prototype'"
    actions:
      skip_phases: ["comprehensive_testing", "formal_documentation"]
      reduce_questions: true
      auto_approve: false  # ãã‚Œã§ã‚‚æ‰¿èªã¯å¿…è¦

  # çŸ­æœŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ1ãƒ¶æœˆæœªæº€ï¼‰
  - condition: "project.timeline < 30"
    actions:
      enable_rapid_mode: true
      skip_phases: ["extensive_documentation"]
      parallel_execution: ["design", "test_planning"]

  # ä½äºˆç®—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
  - condition: "project.budget < 1000000"
    actions:
      use_templates: true
      prefer_open_source: true
      skip_phases: ["expensive_infrastructure_planning"]

  # ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
  - condition: "project.type == 'enterprise'"
    actions:
      require_phases: ["security_review", "compliance_check", "documentation"]
      approval_required_all: true
      validation_strict: true

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
error_handling:
  dependency_not_met:
    action: "block_execution"
    message: "å‰ææ¡ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è©³ç´°: {details}"
    recovery: "show_required_steps"

  document_not_found:
    action: "prompt_regenerate"
    message: "å¿…è¦ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {document}"
    recovery: "regenerate_or_skip"

  approval_rejected:
    action: "rollback_to_phase"
    message: "æ‰¿èªãŒå´ä¸‹ã•ã‚Œã¾ã—ãŸã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚"
    recovery: "edit_and_resubmit"

  phase_timeout:
    action: "save_and_pause"
    message: "ãƒ•ã‚§ãƒ¼ã‚ºãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
    recovery: "resume_from_checkpoint"

# å®Ÿè¡Œåˆ¶å¾¡
execution_control:
  max_phase_duration: 7200  # ç§’ï¼ˆ2æ™‚é–“ï¼‰
  auto_save_interval: 300  # 5åˆ†ã”ã¨ã«è‡ªå‹•ä¿å­˜
  checkpoint_on_approval: true
  allow_force_skip: false  # å¼·åˆ¶ã‚¹ã‚­ãƒƒãƒ—ã‚’è¨±å¯ã—ãªã„
  require_all_questions_answered: true
  allow_parallel_approval: false

# ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«
validation:
  requirements:
    minimum_features: 1
    required_fields: ["project_purpose", "target_users", "main_features"]

  analysis:
    required_fields: ["programming_language", "database", "infrastructure"]

  design:
    required_fields: ["architecture_pattern", "data_models", "api_endpoints"]
    minimum_endpoints: 1

  tasks:
    minimum_tasks: 1
    required_fields: ["prioritization", "critical_path"]
    max_estimated_hours: 10000  # ç•°å¸¸å€¤ãƒã‚§ãƒƒã‚¯

# é€šçŸ¥è¨­å®š
notifications:
  on_phase_complete:
    message: "âœ… {phase_name}ãŒå®Œäº†ã—ã¾ã—ãŸ"
    show_next_action: true

  on_approval_required:
    message: "ğŸ“ {phase_name}ã®æ‰¿èªãŒå¿…è¦ã§ã™"
    show_summary: true

  on_error:
    message: "âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {error}"
    show_recovery_options: true

  on_workflow_complete:
    message: "ğŸ‰ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼"
    show_statistics: true